<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazer Prova (Aluno)</title>
    
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'pt',
                includedLanguages: 'en,it,es,fr,pl', 
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" defer></script>
    
    <style>
        :root { --cor-principal: #005a9c; --cor-sucesso: #28a745; --cor-perigo: #dc3545; --cor-aviso: #ffc107; --cor-fundo: #f4f7f6; --cor-borda: #ddd; }

        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            background-color: var(--cor-fundo); color: #333; line-height: 1.6; margin: 0; padding: 0; top: 0px !important; 
        }
        
        /* --- Header --- */
        .site-header { width: 100%; background-color: var(--cor-principal); color: #fff; padding: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-container { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; }
        .header-container nav { display: flex; align-items: center; gap: 15px; }
        .logo-texto { font-size: 1.5rem; font-weight: 600; color: #fff; text-decoration: none; }
        .btn-header { display: inline-block; padding: 10px 20px; font-size: 0.9rem; font-weight: 600; text-decoration: none; border-radius: 5px; background-color: #fff; color: var(--cor-principal); transition: background-color 0.2s ease, color 0.2s ease; }
        .btn-header:hover { background-color: #f0f0f0; color: #004a80; }

        /* --- Container Principal --- */
        .container { max-width: 800px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        
        /* --- Títulos --- */
        h1, h2 { color: var(--cor-principal); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-top: 0; margin-bottom: 25px; }
        h3 { color: var(--cor-principal); margin-top: 0; }

        /* --- Formulários --- */
        .form-grupo { margin-bottom: 25px; }
        .form-grupo label { display: block; font-weight: 600; margin-bottom: 10px; color: #555; }
        .form-grupo input[type="text"], .form-grupo select { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .form-grupo select { background-color: #fff; } 
        
        /* --- Questões --- */
        .questao-bloco { background: #fdfdfd; border: 1px solid #eee; border-radius: 5px; padding: 20px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .questao-enunciado { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: #333; }
        .opcoes-lista label { display: block; margin-bottom: 12px; padding: 12px 15px; border-radius: 5px; border: 1px solid #eee; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; background-color: #fff; }
        .opcoes-lista label:hover { background-color: #f9f9f9; border-color: #ddd; }
        .opcoes-lista input[type="radio"] { margin-right: 12px; vertical-align: middle; }
        .resposta-escrita { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; min-height: 120px; resize: vertical; font-size: 1rem; }
        
        /* --- Botões --- */
        .btn { display: inline-block; padding: 12px 24px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; border-radius: 5px; background-color: var(--cor-sucesso); color: #fff; transition: background-color 0.2s ease, transform 0.1s ease; text-decoration: none; text-align: center; }
         .btn:active { transform: translateY(1px); }
        .btn:hover:not(:disabled) { background-color: #218838; }
        .btn-secundario { background-color: #6c757d; }
        .btn-secundario:hover:not(:disabled) { background-color: #5a6268; }
        .btn-pequeno { padding: 5px 10px; font-size: 0.8rem; margin-left: 10px;}
        .btn-explicacao { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 0 5px; color: var(--cor-principal); vertical-align: middle; margin-left: 5px; }
        .btn-explicacao:hover { color: #004a80; }
        .btn-explicacao:disabled { color: #ccc; cursor: not-allowed; }
        .btn-audio { /* Botão áudio chat e explicação */
             background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 0 5px; color: var(--cor-principal); vertical-align: middle; margin-left: 5px;
        }
        .btn-audio:hover { color: #004a80; }


        /* --- Resultados --- */
        #resultado-correcao { margin-top: 40px; border-top: 2px solid #eee; padding-top: 30px; }
        .resultado-card { border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 5px; border-left-width: 5px; border-left-style: solid; }
        .resultado-card.correto { background-color: #f0fff4; border-left-color: var(--cor-sucesso); }
        .resultado-card.incorreto { background-color: #fff0f1; border-left-color: var(--cor-perigo); }
        .resultado-card.pendente { background-color: #fffbec; border-left-color: var(--cor-aviso); }
        .resposta-aluno { font-weight: bold; margin-top: 8px; }
        .resposta-correta-info { font-style: italic; color: #555; margin-top: 8px; font-size: 0.9rem; }
         #pontuacao-final { color: var(--cor-principal); font-weight: bold; }
         .explanation-text { background-color: #f0f5fa; border: 1px solid #cce0ff; border-radius: 4px; padding: 10px; margin-top: 15px; font-size: 0.9em; color: #333; }
         .explanation-text:empty { display: none; } 
         .explanation-text.loading { font-style: italic; color: #666; }

         /* --- Chat IA --- */
         #seccao-chat-ia { border: 1px solid var(--cor-borda); border-radius: 8px; margin-bottom: 30px; background-color: #fdfdfd; }
         #chat-header { background-color: #f1f1f1; padding: 15px 20px; border-bottom: 1px solid var(--cor-borda); border-radius: 8px 8px 0 0; }
         #chat-header h2 { margin: 0; font-size: 1.3rem; border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
         #chat-log { height: 300px; overflow-y: auto; padding: 15px; border-bottom: 1px solid var(--cor-borda); background-color: #fff; }
         .chat-message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
         .chat-message.user { background-color: var(--cor-principal); color: #fff; border-bottom-right-radius: 0; margin-left: auto; }
         .chat-message.ai { background-color: #e9ecef; color: #333; border-bottom-left-radius: 0; margin-right: auto; }
          .chat-message.ai .media-links a { display: inline-block; margin-top: 8px; margin-right: 10px; font-size: 0.9em; text-decoration: none; color: var(--cor-principal); font-weight: 500; }
           .chat-message.ai .media-links a:hover { text-decoration: underline; }
         .chat-message p:last-child { margin-bottom: 0; } 
         .chat-input-area { display: flex; padding: 15px; gap: 10px; }
         #chat-input { flex-grow: 1; padding: 12px; border: 1px solid var(--cor-borda); border-radius: 5px; font-size: 1rem; }
         #send-chat-btn { padding: 12px 20px; background-color: var(--cor-principal); border: none; color: white; border-radius: 5px; cursor: pointer; font-size: 1rem; }
         #send-chat-btn:hover { background-color: #004a80; }
         #send-chat-btn:disabled { background-color: #adb5bd; cursor: not-allowed;}

         /* --- Resultados Aluno (Novo) --- */
         .submissao-card { border: 1px solid var(--cor-borda); border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
         .submissao-header { background: #f9f9f9; padding: 15px 20px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
         .submissao-header-info { flex-grow: 1; margin-right: 15px; }
         .submissao-header-info h3 { margin-bottom: 5px; font-size: 1.15rem; color: var(--cor-principal); margin-top: 0;}
         .submissao-header-info p { margin: 0; font-size: 0.9rem; color: #555;}
         .submissao-seta { font-size: 1.2rem; color: var(--cor-principal); transition: transform 0.3s; flex-shrink: 0; }
         .submissao-seta.aberto { transform: rotate(180deg); }
         .submissao-body { padding: 20px; display: none; border-top: 1px solid #eee; background: #fff; }

         /* --- Google Translate --- */
        .goog-te-gadget-simple { background-color: transparent !important; border: 1px solid #fff !important; border-radius: 5px !important; padding: 8px 5px !important; cursor: pointer; }
        .goog-te-gadget-simple span { color: #fff !important; font-weight: 600; font-size: 0.9rem; }
        .goog-te-gadget-icon { display: none !important; }
        .goog-te-banner-frame { display: none !important; }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="header-container">
            <nav>
                <div id="google_translate_element"></div>
                <a href="materiais.html" class="btn-header">Materiais</a>
                <a href="cprova.html" class="btn-header">Modo Professor</a>
            </nav>
            <a href="#" class="logo-texto">Plataforma de Provas</a> 
        </div>
    </header>

    <div class="container">
        
        <div id="seccao-chat-ia">
            <div id="chat-header"> <h2>Assistente de Estudo IA</h2> </div>
            <div id="chat-log">
                 <div class="chat-message ai"><p>Olá! Como posso ajudar nos teus estudos hoje?</p></div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Escreve a tua dúvida...">
                <button id="send-chat-btn" title="Enviar Mensagem">Enviar</button>
            </div>
        </div>

        <h1 id="titulo-pagina">Realizar Prova</h1>
        <div id="seccao-selecao-prova">
            <form id="form-selecao">
                <div class="form-grupo"> <label for="nome-aluno">O seu Nome:</label> <input type="text" id="nome-aluno" placeholder="Escreva o seu nome completo" required> </div>
                <div class="form-grupo"> <label for="dropdown-provas">Provas Disponíveis:</label> <select id="dropdown-provas" required> <option value="" disabled selected>A carregar provas...</option> </select> </div>
                <button type="submit" class="btn">Começar Prova</button>
                <button type="button" id="btn-ver-meus-resultados" class="btn btn-secundario" style="margin-left: 10px;">Ver Minhas Provas</button>
            </form>

            <div id="seccao-resultados-aluno" style="display: none; margin-top: 30px;">
                <h2>As Minhas Provas Respondidas</h2>
                <div id="lista-resultados-aluno">
                    <p>Nenhuma prova respondida com este nome.</p>
                </div>
                <button type="button" id="btn-voltar-selecao" class="btn btn-secundario" style="margin-top: 15px;">Voltar</button>
            </div>
        </div>

        <form id="form-prova" style="display: none;"> <h2 id="titulo-prova"></h2> <div id="questoes-container"></div> <button type="submit" class="btn">Submeter Prova</button> </form>
        
        <div id="resultado-correcao" style="display: none;"> 
            <h2>Resultados da Prova</h2> 
            <h3 id="pontuacao-final"></h3> 
            <div id="respostas-detalhadas"></div> 
            <button type="button" id="btn-voltar-inicio" class="btn btn-secundario" style="margin-top: 20px;">Voltar ao Início</button>
        </div>
    </div>


    <script>
        
        // --- Chave API Gemini ---
        const API_KEY_CHAT = "AIzaSyCp7OEFGoFZUh_CTRRvEPOB95EhbZKgb7g"; // SUBSTITUA PELA SUA CHAVE
        // -------------------------

        let todasAsProvas = [];
        let provaAtual = null; 
        let nomeAlunoAtual = ""; 

        // --- Variáveis Globais Chat e TTS ---
        const chatLog = document.getElementById('chat-log');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const seccaoChatIA = document.getElementById('seccao-chat-ia'); 
        const synth = window.speechSynthesis; 

        try {
            const provasJSON = localStorage.getItem('bancoDeProvas');
            if (provasJSON) {
                todasAsProvas = JSON.parse(provasJSON);
                // Validação básica se é um array
                if (!Array.isArray(todasAsProvas)) {
                    console.error("Formato inválido para 'bancoDeProvas' no localStorage. Esperado um array.");
                    todasAsProvas = []; // Reseta para array vazio
                }
            }
        } catch (error) { 
            console.error("Erro ao ler ou parsear 'bancoDeProvas' do localStorage:", error);
            todasAsProvas = []; // Reseta em caso de erro de parse
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Elementos Prova
            const seccaoSelecaoProva = document.getElementById('seccao-selecao-prova');
            const formSelecao = document.getElementById('form-selecao');
            const dropdownProvas = document.getElementById('dropdown-provas');
            const nomeAlunoInput = document.getElementById('nome-aluno'); 
            const paginaTituloEl = document.getElementById('titulo-pagina');
            const formProvaEl = document.getElementById('form-prova');
            const tituloProvaEl = document.getElementById('titulo-prova');
            const questoesContainerEl = document.getElementById('questoes-container');
            const resultadoCorrecaoEl = document.getElementById('resultado-correcao');
            const pontuacaoFinalEl = document.getElementById('pontuacao-final');
            const respostasDetalhadasEl = document.getElementById('respostas-detalhadas');

            // --- Seletores (para Voltar Início e Ver Resultados) ---
            const btnVoltarInicio = document.getElementById('btn-voltar-inicio');
            const btnVerMeusResultados = document.getElementById('btn-ver-meus-resultados');
            const seccaoResultadosAluno = document.getElementById('seccao-resultados-aluno');
            const listaResultadosAlunoEl = document.getElementById('lista-resultados-aluno');
            const btnVoltarSelecao = document.getElementById('btn-voltar-selecao');
            const formSelecaoContainer = document.getElementById('form-selecao'); // O form em si

            // --- Lógica Chat ---
            sendChatBtn.addEventListener('click', enviarMensagemChat);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !sendChatBtn.disabled) enviarMensagemChat(); });

            async function enviarMensagemChat() {
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                addMessageToChat(userMessage, 'user');
                chatInput.value = ''; chatInput.focus();
                sendChatBtn.disabled = true; 
                addMessageToChat('A pensar...', 'ai', 'pensando'); 
                try {
                    const aiResponseText = await chamarGeminiChatAPI(userMessage);
                    chatLog.querySelector('.pensando')?.remove();
                    addMessageToChat(aiResponseText, 'ai');
                } catch (error) {
                     chatLog.querySelector('.pensando')?.remove();
                     addMessageToChat(`Erro ao contactar a IA: ${error.message}`, 'ai', 'erro');
                     console.error("Erro chat IA:", error);
                } finally { sendChatBtn.disabled = false; }
            }

            function addMessageToChat(text, sender, id = null) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', sender);
                if (id) messageDiv.classList.add(id); 

                const p = document.createElement('p');
                p.textContent = text; 
                messageDiv.appendChild(p);

                if (sender === 'ai' && !id) { 
                    if ('speechSynthesis' in window && synth) {
                        const btnAudio = document.createElement('button');
                        btnAudio.textContent = '🔊'; 
                        btnAudio.title = "Ouvir resposta";
                        btnAudio.classList.add('btn-audio'); 
                        btnAudio.onclick = (event) => {
                            const button = event.currentTarget; 
                            if (button.dataset.speaking === 'true') { synth.cancel(); } 
                            else { lerTexto(text, button); }
                        };
                        messageDiv.appendChild(btnAudio);
                    }
                    const mediaLinksDiv = document.createElement('div'); mediaLinksDiv.classList.add('media-links'); let mediaFound = false;
                    const imgMatch = text.match(/Pesquisar imagens? sobre:\s*(.*)/i);
                    if (imgMatch?.[1]) { const term = imgMatch[1].trim(); const link = document.createElement('a'); link.href = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(term)}`; link.textContent = `🖼️ Ver imagens de "${term}"`; link.target = '_blank'; mediaLinksDiv.appendChild(link); mediaFound = true; }
                    const vidMatch = text.match(/(?:Ver|Pesquisar) vídeos? sobre:\s*(.*)/i);
                     if (vidMatch?.[1]) { const term = vidMatch[1].trim(); const link = document.createElement('a'); link.href = `https://www.youtube.com/results?search_query=${encodeURIComponent(term)}`; link.textContent = `▶️ Ver vídeos sobre "${term}"`; link.target = '_blank'; mediaLinksDiv.appendChild(link); mediaFound = true; }
                    if (mediaFound) messageDiv.appendChild(mediaLinksDiv);
                }
                chatLog.appendChild(messageDiv);
                chatLog.scrollTop = chatLog.scrollHeight; 
            }

            function lerTexto(texto, buttonElement) {
                if (!synth) { alert("Síntese de voz não está disponível."); return; }
                if (synth.speaking) synth.cancel(); 
                if (!texto || !buttonElement) return;

                const utterance = new SpeechSynthesisUtterance(texto);
                utterance.lang = document.documentElement.lang || 'pt-PT'; 

                const resetButtonStyle = () => {
                    buttonElement.textContent = '🔊';
                    buttonElement.title = buttonElement.classList.contains('btn-explicacao') ? "Ouvir explicação" : "Ouvir resposta";
                    delete buttonElement.dataset.speaking;
                    buttonElement.disabled = false; // Garante que é reativado
                };

                utterance.onstart = () => {
                    buttonElement.textContent = '⏹️'; 
                    buttonElement.title = "Parar leitura";
                    buttonElement.dataset.speaking = 'true';
                };
                utterance.onend = resetButtonStyle; 
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesis Error:', event.error); resetButtonStyle(); 
                    alert(`Erro ao ler: ${event.error}`);
                };
                synth.speak(utterance);
            }
            
            async function chamarGeminiChatAPI(pergunta) {
                 if (!API_KEY_CHAT || API_KEY_CHAT.length < 35) throw new Error("Chave API Chat inválida.");
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY_CHAT}`; 
                const prompt = `És um assistente de estudo prestável. Responde à pergunta: "${pergunta}". Se útil, sugere pesquisas usando EXATAMENTE: "Pesquisar imagens sobre: [termo]" ou "Ver vídeos sobre: [termo]". Responde em Português.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } ], generationConfig: { temperature: 0.6 } }; 
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const txt = await response.text(); console.error("API Chat Error:", response.status, txt); throw new Error(`API Chat ${response.status}: ${txt}`); }
                const data = await response.json();
                if (!data.candidates?.[0]?.content?.parts?.[0]?.text) { if (data.promptFeedback?.blockReason) throw new Error(`Bloqueado: ${data.promptFeedback.blockReason}`); console.error("API Chat Resposta Inválida:", data); throw new Error("Resposta IA inválida."); }
                return data.candidates[0].content.parts[0].text;
            }

            async function chamarGeminiExplicacaoAPI(enunciado, respostaAluno, respostaCorreta) {
                if (!API_KEY_CHAT || API_KEY_CHAT.length < 35) throw new Error("Chave API inválida.");
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY_CHAT}`; 
                const prompt = `Explica de forma simples e concisa porque a resposta "${respostaAluno}" está incorreta para a pergunta "${enunciado}", sabendo que a resposta correta é "${respostaCorreta}". Foca-te no erro conceptual. Responde apenas com a explicação em Português.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], safetySettings: [ /*...*/ ], generationConfig: { temperature: 0.5 } }; 
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const txt = await response.text(); console.error("API Explicação Error:", response.status, txt); throw new Error(`API Explicação ${response.status}: ${txt}`); }
                const data = await response.json();
                 if (!data.candidates?.[0]?.content?.parts?.[0]?.text) { if (data.promptFeedback?.blockReason) throw new Error(`Bloqueado: ${data.promptFeedback.blockReason}`); console.error("API Explicação Resposta Inválida:", data); throw new Error("IA não gerou explicação."); }
                return data.candidates[0].content.parts[0].text;
            }

            // --- Lógica da Prova ---
            
            // --- 1. PREENCHER O DROPDOWN ---
            function povoarDropdown() { // GARANTIR QUE ESTÁ DEFINIDA ANTES DE SER CHAMADA
                if (!Array.isArray(todasAsProvas) || todasAsProvas.length === 0) {
                    if(paginaTituloEl) paginaTituloEl.textContent = "Nenhuma Prova Encontrada";
                    if(seccaoSelecaoProva) { 
                        seccaoSelecaoProva.innerHTML = `<p style="color: red; font-weight: bold;">Nenhuma prova encontrada ou formato inválido.<br>Peça ao professor para criar uma prova válida.</p>`;
                    }
                    return;
                }
                
                dropdownProvas.innerHTML = ''; 
                const defaultOption = document.createElement('option'); defaultOption.value = ""; defaultOption.textContent = "Selecione uma prova..."; defaultOption.disabled = true; defaultOption.selected = true; dropdownProvas.appendChild(defaultOption);
                
                todasAsProvas.forEach((prova, index) => {
                    if (prova && typeof prova === 'object' && prova.titulo) { // Verifica se prova e titulo existem
                        const option = document.createElement('option'); option.value = index; 
                        option.textContent = prova.titulo; dropdownProvas.appendChild(option);
                    } else { console.warn(`Prova inválida no índice ${index}. Ignorando.`); }
                });
            } // Fim povoarDropdown

            // Chama povoarDropdown AQUI, dentro do DOMContentLoaded mas após a sua definição
             povoarDropdown(); 

            // --- 2. COMEÇAR A PROVA ---
            formSelecao.addEventListener('submit', (e) => {
                e.preventDefault(); const idx = dropdownProvas.value; nomeAlunoAtual = nomeAlunoInput.value.trim(); 
                if (idx === "" || nomeAlunoAtual === "") { alert("Preencha nome e selecione prova."); return; }
                provaAtual = todasAsProvas[idx];
                if (!provaAtual || !Array.isArray(provaAtual.perguntas)) { alert("Erro: Prova inválida."); return; }
                seccaoChatIA.style.display = 'none'; 
                seccaoSelecaoProva.style.display = 'none'; 
                seccaoResultadosAluno.style.display = 'none'; // <-- Esconde resultados do aluno
                formProvaEl.style.display = 'block';
                if(paginaTituloEl) paginaTituloEl.textContent = `A realizar prova (Aluno: ${nomeAlunoAtual}):`; carregarProva(provaAtual);
            });

            // --- 3. CARREGAR A PROVA ---
            function carregarProva(prova) {
                if(tituloProvaEl) tituloProvaEl.textContent = prova.titulo || "S/ Título"; 
                questoesContainerEl.innerHTML = '';
                 if (!prova || !Array.isArray(prova.perguntas)) { questoesContainerEl.innerHTML = `<p style="color: red;">Erro: Formato inválido.</p>`; return; }
                prova.perguntas.forEach((questao, index) => {
                     if (typeof questao !== 'object' || questao === null || !questao.tipo || !questao.enunciado) {
                         const erroDiv = document.createElement('div'); erroDiv.className = 'questao-bloco';
                         erroDiv.innerHTML = `<p style="color: red;">Erro: Pergunta ${index + 1} mal formatada.</p>`; questoesContainerEl.appendChild(erroDiv); return; 
                     }
                    const questaoDiv = document.createElement('div'); questaoDiv.className = 'questao-bloco';
                     let enunciado = questao.enunciado; let conteudoHTML = `<p class="questao-enunciado">${index + 1}. ${enunciado}</p>`;
                    try { 
                        switch (questao.tipo) {
                            case 'Escolha Múltipla': 
                                if (!Array.isArray(questao.opcoes)) throw new Error("Opções inválidas.");
                                conteudoHTML += '<div class="opcoes-lista">';
                                questao.opcoes.forEach((opcao) => { 
                                     if (typeof opcao === 'object' && opcao !== null && opcao.hasOwnProperty('texto')) {
                                         const valorOpcao = String(opcao.texto); const valorEscapado = valorOpcao.replace(/"/g, '&quot;');
                                         conteudoHTML += `<label><input type="radio" name="q${index}" value="${valorEscapado}" required> ${valorOpcao}</label>`;
                                     } else { console.warn(`Opção inválida na pergunta ${index + 1}:`, opcao); }
                                });
                                conteudoHTML += '</div>'; break;
                            case 'Verdadeiro/Falso': conteudoHTML += `<div class="opcoes-lista"><label><input type="radio" name="q${index}" value="Verdadeiro" required> Verdadeiro</label><label><input type="radio" name="q${index}" value="Falso" required> Falso</label></div>`; break;
                            case 'Resposta Escrita': conteudoHTML += `<textarea name="q${index}" class="resposta-escrita" placeholder="Escreva a sua resposta..." required></textarea>`; break;
                            default: conteudoHTML += `<p style="color: orange;">Tipo não suportado.</p>`;
                        }
                        questaoDiv.innerHTML = conteudoHTML;
                    } catch (error) { console.error(`Erro pergunta ${index + 1}:`, error); questaoDiv.innerHTML = `<p class="questao-enunciado">${index + 1}. ${enunciado}</p><p style="color: red;">Erro opções.</p>`; }
                    questoesContainerEl.appendChild(questaoDiv);
                });
            }

             // --- 4. SUBMETER E CORRIGIR ---
            formProvaEl.addEventListener('submit', (e) => {
                e.preventDefault(); const formData = new FormData(formProvaEl); const respostas = new Map();
                for (let [n, v] of formData.entries()) { respostas.set(n, typeof v === 'string' ? v.replace(/<[^>]*>/g, '') : v); }
                formProvaEl.style.display = 'none'; resultadoCorrecaoEl.style.display = 'block'; 
                // seccaoChatIA.style.display = 'block'; // Mostra chat de novo?
                corrigirProva(respostas, provaAtual);
            });

            // --- 5. FUNÇÃO DE CORREÇÃO ---
            function corrigirProva(respostasAluno, prova) {
                let pontuacao = 0; let totalCorr = 0;
                respostasDetalhadasEl.innerHTML = ''; let detalhesRes = [];
                 if (!prova || !Array.isArray(prova.perguntas)) { respostasDetalhadasEl.innerHTML = '<p style="color: red;">Erro: Correção falhou.</p>'; return; }
                
                prova.perguntas.forEach((questao, index) => {
                     if (typeof questao !== 'object' || questao === null || !questao.tipo || !questao.enunciado) {
                         const errCard = document.createElement('div'); errCard.className = 'resultado-card pendente';
                         errCard.innerHTML = `<p>Pergunta ${index + 1} Inválida</p>`; respostasDetalhadasEl.appendChild(errCard);
                         detalhesRes.push({ enunciado: `Inválida ${index + 1}`, status: 'pendente', info: 'Erro formato.'}); return; 
                     }
                    const nomeInput = `q${index}`;
                    const respAluno = respostasAluno.get(nomeInput) || "Não respondeu";
                    const respAlunoSanit = String(respAluno).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const card = document.createElement('div'); card.className = 'resultado-card';
                    let enunciado = questao.enunciado;
                    // Escapa as aspas no enunciado antes de colocar no data attribute
                    const enunciadoEscapado = enunciado.replace(/"/g, '&quot;'); 
                    let conteudo = `<p class="questao-enunciado">${index + 1}. ${enunciado}</p><p class="resposta-aluno">Sua resposta: ${respAlunoSanit}</p>`;
                    let status = 'pendente'; let info = 'Correção pendente.'; let respCorr = '';
                    let respDef = questao.hasOwnProperty('resposta');
                    let optsDef = Array.isArray(questao.opcoes) && questao.opcoes.length > 0;
                    let optCorrDef = optsDef && questao.opcoes.some(opt => typeof opt === 'object' && opt !== null && opt.correta === true);

                    if (questao.tipo === 'Resposta Escrita') { /* pendente */ } 
                    else if (questao.tipo === 'Verdadeiro/Falso' && respDef) {
                         totalCorr++; respCorr = String(questao.resposta);
                         if (String(respAluno) === respCorr) { status = 'correto'; info = `✓ Correto!`; pontuacao++; } 
                         else { status = 'incorreto'; info = `✗ Incorreto. Correta: ${respCorr}`; }
                    } else if (questao.tipo === 'Escolha Múltipla' && optCorrDef) {
                         totalCorr++; const ocObj = questao.opcoes.find(opt => typeof opt === 'object' && opt !== null && opt.correta === true);
                         // Garante que ocObj e ocObj.texto existem antes de tentar aceder
                         if (ocObj && ocObj.hasOwnProperty('texto')) {
                            respCorr = String(ocObj.texto);
                            if (String(respAluno) === respCorr) { status = 'correto'; info = `✓ Correto!`; pontuacao++; } 
                            else { status = 'incorreto'; info = `✗ Incorreto. Correta: ${respCorr}`; }
                         } else {
                            status = 'pendente'; info = 'Erro definição (opção correta inválida).';
                            console.warn(`Opção correta inválida na pergunta ${index + 1}:`, questao.opcoes);
                         }
                    } else { /* Pendente por erro */
                        if (!optCorrDef && questao.tipo === 'Escolha Múltipla') info = 'Erro definição (sem opção correta).';
                        else if (!respDef && questao.tipo === 'Verdadeiro/Falso') info = 'Erro definição (sem resposta correta).';
                        console.warn(`Correção não aplicável ou erro na pergunta ${index + 1}:`, questao);
                    }
                    card.classList.add(status); 
                    conteudo += `<p class="resposta-correta-info">${info}`;
                    if (status === 'incorreto' && respCorr) {
                         const explanationId = `explanation-${index}`;
                         // Escapa aspas nas respostas também
                         const respAlunoEscapado = respAlunoSanit.replace(/"/g, '&quot;');
                         const respCorrEscapado = respCorr.replace(/"/g, '&quot;');
                         conteudo += ` <button class="btn-explicacao btn-audio" title="Ouvir explicação do erro" 
                                        data-enunciado="${enunciadoEscapado}" 
                                        data-resposta-aluno="${respAlunoEscapado}" 
                                        data-resposta-correta="${respCorrEscapado}"
                                        data-explanation-id="${explanationId}">🔊</button>`;
                         conteudo += `</p><div class="explanation-text" id="${explanationId}"></div>`; 
                    } else { conteudo += `</p>`; }

                    card.innerHTML = conteudo;
                    respostasDetalhadasEl.appendChild(card);
                    detalhesRes.push({ enunciado: enunciado, respostaAluno: respAluno, status: status, info: info });
                });

                if (totalCorr > 0) pontuacaoFinalEl.textContent = `Pontuação (automática): ${pontuacao} / ${totalCorr}`;
                else if (prova.perguntas.length > 0 && prova.perguntas.some(q => typeof q === 'object' && q !== null)) pontuacaoFinalEl.textContent = `Correção manual ou prova com erros.`;
                else pontuacaoFinalEl.textContent = `Prova vazia ou inválida.`;
                
                if(paginaTituloEl) paginaTituloEl.textContent = `Resultados da Prova (Aluno: ${nomeAlunoAtual})`;
                window.scrollTo(0, 0); 

                const resSalvar = { id: new Date().toISOString(), nomeAluno: nomeAlunoAtual, tituloProva: prova.titulo || "S/ Título", pontuacao: pontuacao, totalCorrigiveis: totalCorr, totalPerguntas: prova.perguntas.length, detalhes: detalhesRes };
                try { let banco = JSON.parse(localStorage.getItem('bancoDeResultados')) || []; banco.push(resSalvar); localStorage.setItem('bancoDeResultados', JSON.stringify(banco)); } 
                catch (error) { console.error("Erro salvar resultado:", error); }
            }

            // --- Listener Botões Explicação ---
            respostasDetalhadasEl.addEventListener('click', async (event) => {
                const button = event.target.closest('.btn-explicacao');
                if (!button) return; 

                const explanationId = button.dataset.explanationId;
                const explanationDiv = document.getElementById(explanationId);
                if (!explanationDiv) return;

                 if (button.dataset.speaking === 'true') { synth.cancel(); return; }

                if (explanationDiv.textContent && !explanationDiv.classList.contains('loading')) {
                    lerTexto(explanationDiv.textContent, button); return;
                }
                const enunciado = button.dataset.enunciado; const respAluno = button.dataset.respostaAluno; const respCorr = button.dataset.respostaCorreta;
                explanationDiv.textContent = 'A gerar explicação...'; explanationDiv.classList.add('loading'); button.disabled = true;
                try {
                    const explicacao = await chamarGeminiExplicacaoAPI(enunciado, respAluno, respCorr);
                    explanationDiv.textContent = explicacao; explanationDiv.classList.remove('loading');
                    lerTexto(explicacao, button); 
                } catch (error) {
                    console.error("Erro gerar explicação:", error);
                    explanationDiv.textContent = `Erro: ${error.message}`; explanationDiv.classList.remove('loading'); explanationDiv.style.color = 'red'; 
                    // Reativa botão imediatamente em caso de erro na API
                    button.disabled = false; 
                    button.textContent = '🔊'; 
                    delete button.dataset.speaking;
                } 
                // Não precisa de finally para reativar, pois lerTexto() já faz isso no onend/onerror
            });

            // --- Novos Listeners (Ver Resultados e Voltar) ---

            // Botão "Voltar ao Início" após submeter
            btnVoltarInicio.addEventListener('click', () => {
                resultadoCorrecaoEl.style.display = 'none';
                seccaoChatIA.style.display = 'block';
                seccaoSelecaoProva.style.display = 'block';
                formSelecaoContainer.style.display = 'block'; // Garante que o form é re-exibido
                seccaoResultadosAluno.style.display = 'none'; // Garante que a lista de resultados está escondida
                paginaTituloEl.textContent = "Realizar Prova";
                nomeAlunoInput.value = nomeAlunoAtual; // Mantém o nome do aluno
                dropdownProvas.value = ""; // Reseta o dropdown
            });

            // Botão "Ver Minhas Provas"
            btnVerMeusResultados.addEventListener('click', () => {
                const nomeAluno = nomeAlunoInput.value.trim();
                if (!nomeAluno) {
                    alert("Por favor, insira o seu nome para ver as provas respondidas.");
                    nomeAlunoInput.focus();
                    return;
                }
                nomeAlunoAtual = nomeAluno; // Armazena o nome
                carregarResultadosAluno(nomeAluno);
                formSelecaoContainer.style.display = 'none';
                seccaoResultadosAluno.style.display = 'block';
                paginaTituloEl.textContent = `Provas de: ${nomeAluno}`;
            });

            // Botão "Voltar" (da lista de provas do aluno para a seleção)
            btnVoltarSelecao.addEventListener('click', () => {
                formSelecaoContainer.style.display = 'block';
                seccaoResultadosAluno.style.display = 'none';
                paginaTituloEl.textContent = "Realizar Prova";
            });
            
            // Listener para acordeão dos resultados do aluno
            listaResultadosAlunoEl.addEventListener('click', (e) => {
                const header = e.target.closest('.submissao-header');
                if (!header) return;
                
                e.stopPropagation();
                const sId = header.getAttribute('data-target-id');
                if (!sId) return;
                
                const b = document.getElementById(`body-${sId}`);
                const s = document.getElementById(`seta-${sId}`);
                if (b && s) {
                    const open = b.style.display === 'block';
                    b.style.display = open ? 'none' : 'block';
                    s.classList.toggle('aberto', !open);
                    s.textContent = open ? '▼' : '▲';
                }
            });

            /**
             * (Nova Função) Carrega os resultados filtrados para o aluno atual.
             * @param {string} nomeAluno - O nome do aluno para filtrar.
             */
            function carregarResultadosAluno(nomeAluno) {
                let banco = [];
                try {
                    banco = JSON.parse(localStorage.getItem('bancoDeResultados')) || [];
                    if (!Array.isArray(banco)) banco = [];
                } catch (e) {
                    listaResultadosAlunoEl.innerHTML = '<p style="color: red;">Erro ao ler resultados.</p>';
                    return;
                }

                // Filtra resultados pelo nome do aluno (case-insensitive)
                const meusResultados = banco.filter(sub => sub.nomeAluno && sub.nomeAluno.toLowerCase() === nomeAluno.toLowerCase());

                if (meusResultados.length === 0) {
                    listaResultadosAlunoEl.innerHTML = '<p>Nenhuma prova respondida encontrada com este nome.</p>';
                    return;
                }

                listaResultadosAlunoEl.innerHTML = '';
                meusResultados.slice().reverse().forEach(sub => {
                    if (!sub || typeof sub !== 'object' || !sub.id || !Array.isArray(sub.detalhes)) {
                        return; // Ignora submissões inválidas
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'submissao-card';
                    const data = new Date(sub.id).toLocaleString('pt-PT');
                    let pts = `Pontos: ${sub.pontuacao}/${sub.totalCorrigiveis}`;
                    if (sub.totalCorrigiveis === 0) pts = `Total: ${sub.totalPerguntas} (Correção Manual)`;

                    let hHTML = `
                        <div class="submissao-header" data-target-id="${sub.id}">
                            <div class="submissao-header-info">
                                <h3>${sub.tituloProva || 'S/ Título'}</h3>
                                <p><strong>${pts}</strong></p>
                                <p>Data: ${data}</p>
                            </div>
                            <span class="submissao-seta" id="seta-${sub.id}">▼</span>
                        </div>`;

                    let bHTML = `<div class="submissao-body" id="body-${sub.id}">`;
                    sub.detalhes.forEach((det, i) => {
                        if (typeof det !== 'object' || det === null) return;
                        const rAl = String(det.respostaAluno || "").replace(/</g, "&lt;");
                        bHTML += `
                            <div class="resultado-card ${det.status || 'pendente'}">
                                <p class="questao-enunciado">${i + 1}. ${det.enunciado || 'Inválido'}</p>
                                <p class="resposta-aluno">Sua resposta: ${rAl}</p>
                                <p class="resposta-correta-info">${det.info || 'N/A'}</p>
                            </div>`;
                    });
                    bHTML += '</div>';
                    div.innerHTML = hHTML + bHTML;
                    listaResultadosAlunoEl.appendChild(div);
                });
            }


        }); // Fim DOMContentLoaded
    </script>

</body>
</html>