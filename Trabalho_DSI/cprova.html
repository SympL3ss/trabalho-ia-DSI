<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtor de Provas (Professor)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    
    <link rel="stylesheet" href="css/error.css">
    
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'pt',
                includedLanguages: 'en,it,es,fr,pl', 
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" defer></script>
    <style>
        :root { --cor-principal: #005a9c; --cor-sucesso: #28a745; --cor-perigo: #dc3545; --cor-aviso: #ffc107; --cor-fundo: #f4f7f6; --cor-borda: #ddd; }
        
        /* --- Reset Básico e Body --- */
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            background-color: var(--cor-fundo); color: #333; line-height: 1.6; margin: 0; padding: 0; top: 0px !important; 
        }
        
        /* --- Header --- */
        .site-header { width: 100%; background-color: var(--cor-principal); color: #fff; padding: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-container { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; }
        .header-container nav { display: flex; align-items: center; gap: 15px; }
        .logo-texto { font-size: 1.5rem; font-weight: 600; color: #fff; text-decoration: none; }
        .btn-header { display: inline-block; padding: 10px 20px; font-size: 0.9rem; font-weight: 600; text-decoration: none; border-radius: 5px; background-color: #fff; color: var(--cor-principal); transition: background-color 0.2s ease, color 0.2s ease; }
        .btn-header:hover { background-color: #f0f0f0; color: #004a80; }

        /* --- Container Principal (base para acordeões) --- */
        .container { max-width: 900px; margin: 20px auto; background-color: #fff; padding: 0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: hidden; }
        
        /* --- Títulos (dentro dos acordeões) --- */
        h1, h2, h3 { color: var(--cor-principal); margin-top: 0; }

        /* --- Estilos de Acordeão Genéricos --- */
        .accordion-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 30px; background-color: #fff; }
        .accordion-header h1, .accordion-header h2 { margin-bottom: 0; }
        .accordion-seta { font-size: 1.5rem; color: var(--cor-principal); transition: transform 0.3s; }
        .accordion-seta.aberto { transform: rotate(180deg); }
        .accordion-body { padding: 0 30px 30px 30px; border-top: 2px solid #eee; background-color: #fff; }
        #body-config, #body-construtor, #body-gestao, #body-materiais { padding-top: 30px; }

        /* --- Estilos para acordeões ANINHADOS --- */
        .accordion-nested { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        .accordion-header-nested { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 20px; background-color: #f9f9f9; }
        .accordion-header-nested h3 { margin-bottom: 0; font-size: 1.25rem; }
        .accordion-seta-nested { font-size: 1.2rem; color: var(--cor-principal); transition: transform 0.3s; }
        .accordion-seta-nested.aberto { transform: rotate(180deg); }
        .accordion-body-nested { display: none; padding: 20px; border-top: 1px solid #eee; background-color: #f9f9f9; }
        
        /* --- Formulários --- */
        .form-grupo { margin-bottom: 20px; }
        .form-grupo label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
        .form-grupo input[type="text"], .form-grupo input[type="password"], .form-grupo input[type="number"], .form-grupo textarea { width: 100%; padding: 12px; border: 1px solid var(--cor-borda); border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        .form-grupo textarea { min-height: 80px; resize: vertical; }
        
        /* --- Botões --- */
        .btn { display: inline-block; padding: 12px 24px; font-size: 1rem; font-weight: 600; text-align: center; text-decoration: none; cursor: pointer; border: none; border-radius: 5px; transition: background-color 0.2s ease, transform 0.1s ease; margin-right: 10px; margin-bottom: 10px; }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { background-color: #adb5bd; cursor: not-allowed; }
        .btn-primario { background-color: var(--cor-principal); color: #fff; }
        .btn-primario:hover:not(:disabled) { background-color: #004a80; }
        .btn-secundario { background-color: #6c757d; color: #fff; }
        .btn-sucesso { background-color: var(--cor-sucesso); color: #fff; }
        .btn-aviso { background-color: var(--cor-aviso); color: #212529; }
        .btn-perigo { background-color: var(--cor-perigo); color: #fff; font-size: 0.8rem; padding: 5px 10px; }
        
        /* --- Construtor de Provas --- */
        #lista-perguntas-preview { margin-top: 20px; border: 1px dashed var(--cor-borda); padding: 20px; min-height: 100px; background: #fafafa; border-radius: 5px; }
        #lista-perguntas-preview:empty::before { content: "Nenhuma pergunta adicionada."; color: #888; font-style: italic; display: block; text-align: center; padding: 20px 0; }
        .pergunta-card { background: #fff; border: 1px solid var(--cor-borda); border-radius: 5px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .pergunta-card-conteudo { flex-grow: 1; }
        .pergunta-card-tipo { font-size: 0.75rem; font-weight: 700; color: var(--cor-principal); background-color: #e6f0ff; padding: 4px 10px; border-radius: 12px; display: inline-block; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .pergunta-card-enunciado { font-weight: 600; margin-bottom: 8px; font-size: 1.05rem; word-break: break-word; }
        .pergunta-card-opcoes { font-size: 0.95rem; color: #555; list-style: none; padding-left: 0; margin: 10px 0 0 0; }
        .pergunta-card-opcoes li { margin-bottom: 5px; padding-left: 20px; position: relative; word-break: break-word; }
        .pergunta-card-opcoes li::before { content: '○'; position: absolute; left: 0; color: #aaa; }
        .pergunta-card-opcoes li.correta { font-weight: 700; color: var(--cor-sucesso); }
        .pergunta-card-opcoes li.correta::before { content: '✓'; color: var(--cor-sucesso); }
        
        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-conteudo { background-color: #fff; margin: auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 550px; position: relative; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-fechar { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal-fechar:hover { color: #333; }
        .form-pergunta, .view-modal { display: none; }
        #form-multipla .opcao-grupo { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        #form-multipla .opcao-grupo input[type="radio"] { flex-shrink: 0; width: auto; }
        #form-multipla .opcao-grupo input[type="text"] { flex-grow: 1; }
        #form-vf .opcoes-vf { display: flex; gap: 20px; align-items: center; margin-top: 10px; }
        #form-vf .opcoes-vf label { display: flex; align-items: center; gap: 5px; }
        #form-gerar-ia .form-grupo { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        #form-gerar-ia .form-grupo label { flex-basis: auto; margin-bottom: 0; }
        #form-gerar-ia .form-grupo input { flex-basis: 80px; text-align: right; }
        #form-gerar-ia button { margin-top: 15px; width: 100%; }
        #ia-tema-preview { background-color: #e9ecef; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
        
        /* --- Overlay de Loading --- */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 1001; justify-content: center; align-items: center; text-align: center; }
        .loading-overlay p { font-weight: bold; color: var(--cor-principal); }

        /* --- Acordeão de PROVAS CRIADAS --- */
        .prova-criada-card { background: #fff; border: 1px solid var(--cor-borda); border-radius: 5px; margin-bottom: 15px; padding: 0; overflow: hidden; }
        .prova-criada-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; background-color: #fff; }
        .prova-criada-header h4 { margin: 0; font-size: 1.1rem; color: #333; }
        .prova-criada-header p { margin: 5px 0 0; font-size: 0.9rem; color: #666; }
        .prova-criada-info { flex-grow: 1; margin-right: 15px; }
        .prova-criada-acoes { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        .prova-criada-seta { font-size: 1.2rem; color: var(--cor-principal); transition: transform 0.3s; }
        .prova-criada-seta.aberto { transform: rotate(180deg); }
        .prova-criada-body { display: none; padding: 15px; background: #fdfdfd; border-top: 1px solid #eee; }
        .prova-criada-body .pergunta-card { background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }

        /* --- Acordeão de RESULTADOS SUBMETIDOS --- */
        .submissao-card { border: 1px solid var(--cor-borda); border-radius: 8px; margin-bottom: 15px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        .submissao-header { background: #f9f9f9; padding: 15px 20px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .submissao-card:not(:has(.submissao-body[style*="display: block"])) .submissao-header { border-bottom: none; } /* Remove borda se fechado */
        .submissao-header-info { flex-grow: 1; margin-right: 15px; }
        .submissao-header-info h3 { margin-bottom: 5px; font-size: 1.15rem;}
        .submissao-header-info p { margin: 0; font-size: 0.9rem; color: #555;}
        .submissao-header-info .submissao-pontuacao-header { display: none; }
        .submissao-seta { font-size: 1.2rem; color: var(--cor-principal); transition: transform 0.3s; flex-shrink: 0; }
        .submissao-seta.aberto { transform: rotate(180deg); }
        .submissao-body { padding: 20px; display: none; border-top: 1px solid #eee; background: #fff; }

        /* --- Cards de Resultado (Reutilizados) --- */
        .resultado-card { border: 1px solid #ddd; padding: 20px; margin-bottom: 15px; border-radius: 5px; border-left-width: 5px; border-left-style: solid; }
        .resultado-card.correto { background-color: #f0fff4; border-left-color: var(--cor-sucesso); }
        .resultado-card.incorreto { background-color: #fff0f1; border-left-color: var(--cor-perigo); }
        .resultado-card.pendente { background-color: #fffbec; border-left-color: var(--cor-aviso); }
        .questao-enunciado { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: #333; word-break: break-word; }
        .resposta-aluno { font-weight: bold; margin-top: 8px; word-break: break-word;}
        .resposta-correta-info { font-style: italic; color: #555; margin-top: 8px; font-size: 0.9rem; word-break: break-word;}

        /* --- Google Translate --- */
        .goog-te-gadget-simple { background-color: transparent !important; border: 1px solid #fff !important; border-radius: 5px !important; padding: 8px 5px !important; cursor: pointer; }
        .goog-te-gadget-simple span { color: #fff !important; font-weight: 600; font-size: 0.9rem; }
        .goog-te-gadget-icon { display: none !important; }
        .goog-te-banner-frame { display: none !important; }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="header-container">
            <nav>
                <div id="google_translate_element"></div>
                <a href="fprova.html" class="btn-header">Modo Aluno</a>
            </nav>
            <a href="#" class="logo-texto">Plataforma de Provas</a>
        </div>
    </header>

    <div id="seccao-config" class="container">
        <div class="accordion-header" data-target="body-config">
            <h1>Montar Nova Prova</h1>
            <span class="accordion-seta aberto">▲</span>
        </div>
        <div id="body-config" class="accordion-body" style="display: block;">
            <form id="form-config-prova">
                <div class="form-grupo"> <label for="titulo-prova">Título da Prova</label> <input type="text" id="titulo-prova" placeholder="Ex: Teste Avaliação Módulo 1" required> </div>
                <div class="form-grupo"> <label for="temas-prova">Tema para IA Gerar Perguntas</label> <input type="text" id="temas-prova" placeholder="Ex: Revolução Francesa, Fotossíntese" required> </div>
                <button type="submit" class="btn btn-primario">Iniciar Construção</button>
            </form>
        </div>
    </div>

    <div id="seccao-construtor" class="container" style="display: none; margin-top: 20px;">
        <div class="accordion-header" data-target="body-construtor">
            <h2 id="titulo-preview">A construir...</h2>
            <span class="accordion-seta aberto">▲</span>
        </div>
        <div id="body-construtor" class="accordion-body" style="display: block;">
            <button id="btn-modal-manual" class="btn btn-sucesso">+ Pergunta Manual</button>
            <button id="btn-modal-ia" class="btn btn-aviso">Gerar Perguntas IA</button>
            <h3 style="margin-top: 30px;">Perguntas da Prova</h3>
            <div id="lista-perguntas-preview"></div>
            <button id="btn-guardar-prova" class="btn btn-primario" style="margin-top: 20px;">Guardar Prova Completa</button>
        </div>
    </div>

    <div id="seccao-gestao" class="container" style="margin-top: 20px;">
        <div class="accordion-header" data-target="body-gestao">
            <h2>Gestão de Provas e Resultados</h2>
            <span class="accordion-seta">▼</span> 
        </div>
        <div id="body-gestao" class="accordion-body" style="display: none;">
            <div id="seccao-provas-criadas" class="accordion-nested">
                <div class="accordion-header-nested" data-target="body-provas-criadas"> <h3>As Minhas Provas Criadas</h3> <span class="accordion-seta-nested">▼</span> </div>
                <div id="body-provas-criadas" class="accordion-body-nested"> <div id="lista-provas-criadas"><p>A carregar...</p></div> </div>
            </div>
            <div id="seccao-resultados-professor" class="accordion-nested">
                 <div class="accordion-header-nested" data-target="body-resultados"> <h3>Resultados Submetidos</h3> <span class="accordion-seta-nested">▼</span> </div>
                <div id="body-resultados" class="accordion-body-nested"> <div id="lista-resultados"><p>A carregar...</p></div> </div>
            </div>
        </div>
    </div>

    <div id="seccao-materiais" class="container" style="margin-top: 20px;">
        <div class="accordion-header" data-target="body-materiais">
            <h2>Gestão de Materiais</h2>
            <span class="accordion-seta">▼</span> 
        </div>
        <div id="body-materiais" class="accordion-body" style="display: none;">
            <button id="btn-add-material" class="btn btn-sucesso">+ Novo Material</button>
            <div id="lista-materiais" style="margin-top: 20px;">
                <p>A carregar materiais...</p>
            </div>
        </div>
    </div>

    <div id="modal-pergunta" class="modal">
        <div class="modal-conteudo">
            <span class="modal-fechar">&times;</span>
            <div id="view-ia-gerar" class="view-modal">
                <h3>Gerar Perguntas com IA</h3> <p>Tema: <strong id="ia-tema-preview"></strong></p>
                <form id="form-gerar-ia">
                    <div class="form-grupo"> <label for="ia-num-multipla">Nº Escolha Múltipla:</label> <input type="number" id="ia-num-multipla" value="5" min="0"> </div>
                    <div class="form-grupo"> <label for="ia-num-vf">Nº Verdadeiro/Falso:</label> <input type="number" id="ia-num-vf" value="3" min="0"> </div>
                    <div class="form-grupo"> <label for="ia-num-escrita">Nº Resposta Escrita:</label> <input type="number" id="ia-num-escrita" value="2" min="0"> </div>
                    <button type="submit" id="btn-submit-ia" class="btn btn-primario">Gerar Perguntas</button>
                </form>
            </div>
            <div id="view-manual-selecao" class="view-modal">
                <h2>Adicionar Pergunta Manual</h2> <p>Escolha o tipo:</p>
                <button class="btn btn-secundario" data-tipo="vf">V/F</button>
                <button class="btn btn-secundario" data-tipo="escrita">Escrita</button>
                <button class="btn btn-secundario" data-tipo="multipla">Múltipla</button>
            </div>
            <form id="form-vf" class="form-pergunta">
                <h3>Pergunta Verdadeiro/Falso</h3>
                <div class="form-grupo"><label for="vf-enunciado">Afirmação</label><textarea id="vf-enunciado" rows="3" required></textarea></div>
                <div class="form-grupo"><label>Resposta Correta</label><div class="opcoes-vf"><label><input type="radio" name="vf-resposta" value="Verdadeiro" required> V</label><label><input type="radio" name="vf-resposta" value="Falso"> F</label></div></div>
                <button type="submit" class="btn btn-sucesso">Guardar</button> <button type="button" class="btn btn-secundario btn-voltar-selecao">Voltar</button>
            </form>
            <form id="form-escrita" class="form-pergunta">
                <h3>Pergunta Resposta Escrita</h3>
                <div class="form-grupo"><label for="escrita-enunciado">Enunciado</label><textarea id="escrita-enunciado" rows="4" required></textarea></div>
                <button type="submit" class="btn btn-sucesso">Guardar</button> <button type="button" class="btn btn-secundario btn-voltar-selecao">Voltar</button>
            </form>
            <form id="form-multipla" class="form-pergunta">
                <h3>Pergunta Escolha Múltipla</h3>
                <div class="form-grupo"><label for="multipla-enunciado">Enunciado</label><textarea id="multipla-enunciado" rows="3" required></textarea></div>
                <div class="form-grupo"><label>Opções (Marque a correta)</label><div id="opcoes-container"></div><button type="button" id="btn-add-opcao" class="btn btn-secundario" style="margin-top: 10px;">+ Opção</button></div>
                <button type="submit" class="btn btn-sucesso">Guardar</button> <button type="button" class="btn btn-secundario btn-voltar-selecao">Voltar</button>
            </form>
        </div>
    </div>
    
    <div id="modal-material" class="modal">
        <div class="modal-conteudo">
            <span class="modal-fechar" id="modal-material-fechar">&times;</span>
            <h3 id="modal-material-titulo">Novo Material</h3>
            <form id="form-material">
                <input type="hidden" id="material-id">
                <div class="form-grupo">
                    <label for="material-titulo">Título</label>
                    <input type="text" id="material-titulo" placeholder="Ex: Resumo sobre a Revolução Francesa" required>
                </div>
                <div class="form-grupo">
                    <label for="material-conteudo">Conteúdo</label>
                    <small style="display:block; margin-top:-8px; margin-bottom:8px; color: #555;">Pode usar HTML (ex: &lt;b&gt;, &lt;p&gt;) ou os botões de ajuda.</small>
                    
                    <div class="material-helpers" style="margin-bottom: 8px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secundario" id="btn-add-material-img" style="padding: 5px 10px; font-size: 0.9rem;">+ Imagem (URL)</button>
                        <button type="button" class="btn btn-secundario" id="btn-add-material-youtube" style="padding: 5px 10px; font-size: 0.9rem;">+ Vídeo (YouTube)</button>
                        <button type="button" class="btn btn-secundario" id="btn-add-material-mp4" style="padding: 5px 10px; font-size: 0.9rem;">+ Vídeo (MP4 URL)</button>
                    </div>

                    <textarea id="material-conteudo" rows="12" required></textarea>
                </div>
                <button type="submit" class="btn btn-primario">Guardar Material</button>
            </form>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay"><p>A verificar API Key...</p></div>

    <script>
        // --- Chave API Gemini ---
        const API_KEY = "AIzaSyCp7OEFGoFZUh_CTRRvEPOB95EhbZKgb7g"; // SUBSTITUA PELA SUA CHAVE
        // -------------------------

        document.addEventListener('DOMContentLoaded', async () => {
            // Ensure errorService exists (fallback stub) so page scripts don't throw if the file
            // wasn't loaded for any reason. If a real errorService is present it will be used.
            const errorService = window.errorService || (function(){
                const stub = {
                    registerHandler: function() {},
                    createErrorBoundary: function(msg){ return { show: function(){} }; },
                    handleError: function(type, err){ console.error('[stub errorService]', type, err); }
                };
                window.errorService = stub;
                return stub;
            })();
            
            // Register custom error handlers
            errorService.registerHandler('api', (error) => {
                loadingOverlay.style.display = 'none';
                btnSubmitIA.disabled = false;
                btnSubmitIA.textContent = "Gerar Perguntas";
                alert(`Erro API: ${error.message}`);
            });
            
            errorService.registerHandler('storage', (error) => {
                alert(`Erro de armazenamento: ${error.message}. Tente limpar o cache.`);
            });

            // Create error boundary
            const errorBoundary = errorService.createErrorBoundary('Ocorreu um erro ao processar sua solicitação. Por favor, tente novamente.');
            
            let provaPerguntas = [];
            let tituloProvaGlobal = "";

            // --- Seletores ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = loadingOverlay.querySelector('p');
            const formConfig = document.getElementById('form-config-prova');
            const seccaoConfig = document.getElementById('seccao-config');
            const seccaoConstrutor = document.getElementById('seccao-construtor');
            const tituloPreview = document.getElementById('titulo-preview');
            const temasInput = document.getElementById('temas-prova');
            const modal = document.getElementById('modal-pergunta');
            const btnFecharModal = document.querySelector('.modal-fechar');
            const btnModalManual = document.getElementById('btn-modal-manual');
            const btnModalIA = document.getElementById('btn-modal-ia');
            const allModalViews = document.querySelectorAll('.view-modal, .form-pergunta');
            const viewIAGerar = document.getElementById('view-ia-gerar');
            const viewManualSelecao = document.getElementById('view-manual-selecao');
            const btnsTipoManual = document.querySelectorAll('#view-manual-selecao .btn');
            const formGerarIA = document.getElementById('form-gerar-ia');
            const iaTemaPreview = document.getElementById('ia-tema-preview');
            const iaNumMultipla = document.getElementById('ia-num-multipla');
            const iaNumVF = document.getElementById('ia-num-vf');
            const iaNumEscrita = document.getElementById('ia-num-escrita');
            const btnSubmitIA = document.getElementById('btn-submit-ia');
            const formVF = document.getElementById('form-vf');
            const formEscrita = document.getElementById('form-escrita');
            const formMultipla = document.getElementById('form-multipla');
            const btnAddOpcao = document.getElementById('btn-add-opcao');
            const opcoesContainer = document.getElementById('opcoes-container');
            const listaPerguntasPreview = document.getElementById('lista-perguntas-preview');
            const btnGuardarProva = document.getElementById('btn-guardar-prova');
            const btnsVoltarSelecao = document.querySelectorAll('.btn-voltar-selecao');
            const seccaoGestao = document.getElementById('seccao-gestao');
            const listaResultadosEl = document.getElementById('lista-resultados');
            const listaProvasCriadasEl = document.getElementById('lista-provas-criadas');

            // --- Seletores de Materiais ---
            const seccaoMateriais = document.getElementById('seccao-materiais');
            const btnAddMaterial = document.getElementById('btn-add-material');
            const listaMateriaisEl = document.getElementById('lista-materiais');
            const modalMaterial = document.getElementById('modal-material');
            const modalMaterialFechar = document.getElementById('modal-material-fechar');
            const formMaterial = document.getElementById('form-material');
            const modalMaterialTitulo = document.getElementById('modal-material-titulo');
            const materialIdInput = document.getElementById('material-id');
            const materialTituloInput = document.getElementById('material-titulo');
            const materialConteudoInput = document.getElementById('material-conteudo');
            
            // --- Seletores de Ajuda Materiais (Atualizados) ---
            const btnAddMaterialImg = document.getElementById('btn-add-material-img');
            const btnAddMaterialYoutube = document.getElementById('btn-add-material-youtube');
            const btnAddMaterialMp4 = document.getElementById('btn-add-material-mp4');

            // --- Verificação API Key ---
             if (!API_KEY || API_KEY.startsWith("AIza") === false || API_KEY.length < 35) { 
                loadingText.textContent = "ERRO: API Key inválida/não definida!"; loadingOverlay.style.backgroundColor = "rgba(255, 0, 0, 0.8)"; loadingOverlay.style.display = 'flex'; 
                alert("ERRO: API Key inválida ou não definida no código JS. Edite o ficheiro."); return; 
            } else {
                 try {
                     loadingText.textContent = "A validar API Key..."; loadingOverlay.style.display = 'flex';
                     await validarAPIKey(); loadingOverlay.style.display = 'none'; 
                     carregarProvasCriadas(); 
                     carregarResultadosProfessor();
                     carregarMateriais();
                 } catch (error) {
                     loadingText.innerHTML = `ERRO: ${error.message}<br/>Verifique Key, API ativa no Google Cloud, e Local Storage.`;
                     loadingOverlay.style.backgroundColor = "rgba(255, 100, 0, 0.8)"; loadingOverlay.style.display = 'flex'; 
                     alert(`ERRO: ${error.message}\n\nVerifique API Key/ativação e tente limpar Local Storage (F12 > Application).`);
                     // Mesmo com erro de API, tenta carregar do localStorage
                     carregarProvasCriadas(); 
                     carregarResultadosProfessor();
                     carregarMateriais();
                 }
            }
            
            // --- Botão "Iniciar Construção" ---
            formConfig.addEventListener('submit', (e) => {
                e.preventDefault(); const titulo = document.getElementById('titulo-prova').value.trim(); const tema = temasInput.value.trim();
                if (!titulo || !tema) { alert('Preencha Título e Tema.'); return; }
                tituloProvaGlobal = titulo; tituloPreview.textContent = `Construindo: "${titulo}"`;
                toggleAccordion('body-config', false); seccaoConstrutor.style.display = 'block'; toggleAccordion('body-construtor', true); seccaoGestao.style.display = 'none'; 
                provaPerguntas = []; renderizarPreviewPerguntas();
            });

            // --- Lógica Modal ---
            btnFecharModal.addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
            btnModalManual.addEventListener('click', () => { resetarModal(); viewManualSelecao.style.display = 'block'; modal.style.display = 'flex'; });
            btnModalIA.addEventListener('click', () => {
                const tema = temasInput.value.trim(); if (!tema) { alert("Preencha Tema."); temasInput.focus(); return; }
                resetarModal(); iaTemaPreview.textContent = tema; viewIAGerar.style.display = 'block'; modal.style.display = 'flex';
            });
            btnsVoltarSelecao.forEach(btn => { btn.addEventListener('click', () => { resetarModal(); viewManualSelecao.style.display = 'block'; }); });
            btnsTipoManual.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tipo = btn.getAttribute('data-tipo'); viewManualSelecao.style.display = 'none'; document.getElementById(`form-${tipo}`).style.display = 'block'; 
                    if (tipo === 'multipla') { opcoesContainer.innerHTML = ''; adicionarNovaOpcao(); adicionarNovaOpcao(); }
                });
            });

            // --- Listeners de Materiais ---
            btnAddMaterial.addEventListener('click', () => abrirModalMaterial(null));
            modalMaterialFechar.addEventListener('click', fecharModalMaterial);
            formMaterial.addEventListener('submit', salvarMaterial);
            
            // Listener para botões de editar/remover materiais
            listaMateriaisEl.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('btn-editar-material')) {
                    e.stopPropagation();
                    const id = target.dataset.id;
                    editarMaterial(id);
                } else if (target.classList.contains('btn-remover-material')) {
                    e.stopPropagation();
                    const id = target.dataset.id;
                    if (confirm('Tem a certeza que deseja remover este material?')) {
                        removerMaterial(id);
                    }
                }
            });

            // Fechar modal de material ao clicar fora
            modalMaterial.addEventListener('click', (e) => {
                if (e.target === modalMaterial) {
                    fecharModalMaterial();
                }
            });

            // --- Listeners de Ajuda Materiais (Atualizados) ---
            btnAddMaterialImg.addEventListener('click', inserirImagemMaterial);
            btnAddMaterialYoutube.addEventListener('click', inserirVideoYoutube);
            btnAddMaterialMp4.addEventListener('click', inserirVideoMp4);


            // --- Lógica Escolha Múltipla ---
            btnAddOpcao.addEventListener('click', adicionarNovaOpcao);
            function adicionarNovaOpcao() {
                const total = opcoesContainer.children.length; const div = document.createElement('div'); div.className = 'opcao-grupo';
                div.innerHTML = `<input type="radio" name="opcao-correta" required title="Marque correta"><input type="text" placeholder="Opção ${total + 1}" required><button type="button" class="btn btn-perigo btn-remover-opcao" title="Remover">X</button>`;
                div.querySelector('.btn-remover-opcao').addEventListener('click', () => { if (opcoesContainer.children.length > 2) div.remove(); else alert('Mínimo 2 opções.'); });
                opcoesContainer.appendChild(div);
            }

            // --- Guardar Perguntas Manuais ---
            formVF.addEventListener('submit', (e) => { e.preventDefault(); adicionarPerguntaAoArray({ tipo: 'Verdadeiro/Falso', enunciado: document.getElementById('vf-enunciado').value, resposta: document.querySelector('input[name="vf-resposta"]:checked').value }); formVF.reset(); modal.style.display = 'none'; });
            formEscrita.addEventListener('submit', (e) => { e.preventDefault(); adicionarPerguntaAoArray({ tipo: 'Resposta Escrita', enunciado: document.getElementById('escrita-enunciado').value }); formEscrita.reset(); modal.style.display = 'none'; });
            formMultipla.addEventListener('submit', (e) => {
                e.preventDefault(); const ops = []; let ok = false;
                opcoesContainer.querySelectorAll('.opcao-grupo').forEach(g => { const chk = g.querySelector('input[type="radio"]').checked; ops.push({ texto: g.querySelector('input[type="text"]').value, correta: chk }); if(chk) ok = true; });
                if (!ok) { alert("Marque uma opção correta."); return; }
                adicionarPerguntaAoArray({ tipo: 'Escolha Múltipla', enunciado: document.getElementById('multipla-enunciado').value, opcoes: ops });
                formMultipla.reset(); modal.style.display = 'none';
            });

            // --- Gerar por IA ---
            formGerarIA.addEventListener('submit', async (e) => {
                e.preventDefault(); const tema = temasInput.value.trim(); const nMult = parseInt(iaNumMultipla.value, 10) || 0; const nVF = parseInt(iaNumVF.value, 10) || 0; const nEsc = parseInt(iaNumEscrita.value, 10) || 0; const tot = nMult + nVF + nEsc; if (tot <= 0) { alert("Peça > 0 perguntas."); return; }
                btnSubmitIA.disabled = true; btnSubmitIA.textContent = "A Gerar..."; loadingOverlay.style.display = 'flex'; loadingText.textContent = `Gerando ${tot} sobre "${tema}"...`;
                try {
                    const pIA = await chamarGeminiAPI(tema, nMult, nVF, nEsc); provaPerguntas = provaPerguntas.concat(pIA); renderizarPreviewPerguntas(); alert(`${tot} perguntas adicionadas!`); modal.style.display = 'none'; 
                } catch (err) { console.error("Erro API:", err); alert(`Erro gerar: ${err.message}`); } 
                finally { btnSubmitIA.disabled = false; btnSubmitIA.textContent = "Gerar Perguntas"; loadingOverlay.style.display = 'none'; }
            });

            // --- Guardar Prova Completa ---
            btnGuardarProva.addEventListener('click', () => {
                if (provaPerguntas.length === 0) { alert('Prova vazia.'); return; }
                const provaCompleta = { titulo: tituloProvaGlobal, perguntas: provaPerguntas }; let banco = [];
                try { banco = JSON.parse(localStorage.getItem('bancoDeProvas')) || []; if(!Array.isArray(banco)) banco = []; } catch (e) { banco = []; }
                const idx = banco.findIndex(p => p && p.titulo === tituloProvaGlobal);
                if(idx !== -1) { if(!confirm(`Substituir prova "${tituloProvaGlobal}"?`)) return; banco.splice(idx, 1); }
                banco.push(provaCompleta); 
                try { localStorage.setItem('bancoDeProvas', JSON.stringify(banco)); } catch (e) { alert("Erro ao guardar. LocalStorage cheio?"); return; }
                alert(`Prova "${tituloProvaGlobal}" guardada!`);
                seccaoConstrutor.style.display = 'none'; seccaoConfig.style.display = 'block'; toggleAccordion('body-config', true); seccaoGestao.style.display = 'block'; toggleAccordion('body-gestao', false); 
                toggleAccordion('body-provas-criadas', false); toggleAccordion('body-resultados', false); // Fecha sub-secções
                carregarProvasCriadas(); carregarResultadosProfessor(); formConfig.reset(); 
            });

            // --- Chamar Gemini API ---
            async function chamarGeminiAPI(tema, numMultipla, numVF, numEscrita) {
                try {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY}`;
                    const prompt = `Crie perguntas teste sobre: "${tema}". Gere EXATAMENTE: ${numMultipla} de "Escolha Múltipla", ${numVF} de "Verdadeiro/Falso", ${numEscrita} de "Resposta Escrita". REGRAS: Múltipla: 3-4 opções, UMA correta ({"texto": "...", "correta": true/false}). V/F: Resposta "Verdadeiro" ou "Falso". Escrita: Sem resposta. RESPONDA APENAS com array JSON válido [ ... ] com ${numMultipla + numVF + numEscrita} objetos. Sem texto extra/markdown. Formato: [{"tipo": "...", "enunciado": "...", ...}, ...]`;
                    const payload = { 
                        contents: [{ parts: [{ text: prompt }] }], 
                        safetySettings: [ 
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, 
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, 
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, 
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" } 
                        ], 
                        generationConfig: { temperature: 0.7 } 
                    };

                    const response = await fetch(API_URL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });

                    if (!response.ok) { 
                        const txt = await response.text(); 
                        let msg = `Erro ${response.status}. `; 
                        try { 
                            const data = JSON.parse(txt); 
                            msg += data.error.message || ""; 
                        } catch { 
                            msg += "Erro API."; 
                        } 
                        errorService.handleError('api', new Error(msg));
                        return [];
                    }

                    const data = await response.json();
                    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) { 
                        if (data.promptFeedback?.blockReason) {
                            errorService.handleError('api', new Error(`Bloqueado: ${data.promptFeedback.blockReason}`));
                            return [];
                        }
                        errorService.handleError('api', new Error("Resposta API inválida."));
                        return [];
                    }

                    const txt = data.candidates[0].content.parts[0].text;
                    const clean = txt.replace(/^```json\s*/, '').replace(/\s*```$/, '').trim(); 
                    const json = JSON.parse(clean); 

                    if (!Array.isArray(json)) {
                        errorService.handleError('api', new Error("Resposta não é um array."));
                        return [];
                    }

                    return json;
                } catch (error) {
                    errorService.handleError('api', error);
                    return [];
                }
            }
            
            // --- Validar API Key ---
            async function validarAPIKey() {
                const URL = `https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`;
                try {
                    const res = await fetch(URL);
                    if (!res.ok) {
                        let error;
                        if (res.status === 400) {
                            error = new Error("API Key inválida.");
                        } else if (res.status === 403) {
                            error = new Error("Permissão Negada. API não ativa?");
                        } else {
                            const errData = await res.json().catch(() => null);
                            error = new Error(errData?.error?.message || `Erro ${res.status}`);
                        }
                        errorService.handleError('api', error);
                        throw error;
                    }
                    console.log("API Key OK.");
                    return true;
                } catch (err) {
                    console.error("Erro validação:", err);
                    errorService.handleError('api', err);
                    throw err;
                }
            }

            // --- Lógica Acordeão ---
            function toggleAccordion(bodyId, forceOpen = null) {
                const body = document.getElementById(bodyId); const header = document.querySelector(`[data-target="${bodyId}"]`); if (!body || !header) return;
                const seta = header.querySelector('.accordion-seta, .accordion-seta-nested'); const isOpen = body.style.display === 'block';
                let abrir = (forceOpen === null) ? !isOpen : forceOpen;
                body.style.display = abrir ? 'block' : 'none';
                if (seta) { seta.textContent = abrir ? '▲' : '▼'; seta.classList.toggle('aberto', abrir); }
            }
            document.querySelectorAll('.accordion-header, .accordion-header-nested').forEach(hdr => { hdr.addEventListener('click', (e) => { e.stopPropagation(); toggleAccordion(hdr.getAttribute('data-target')); }); });

            // --- Gerar HTML Detalhe Prova ---
            function gerarHTMLDetalheProva(perguntas) {
                if (!Array.isArray(perguntas)) return '<p>Erro: formato inválido.</p>'; if (perguntas.length === 0) return '<p>Prova vazia.</p>';
                let html = '';
                perguntas.forEach((p, i) => {
                    if (typeof p !== 'object' || p === null) { html += `<div class="pergunta-card erro"><p>Erro: Pergunta ${i + 1} inválida.</p></div>`; return; }
                    let inner = '';
                    if (p.tipo === 'Escolha Múltipla' && Array.isArray(p.opcoes)) {
                        inner = '<ul class="pergunta-card-opcoes">'; p.opcoes.forEach(opt => { inner += (typeof opt === 'object' && opt !== null && opt.hasOwnProperty('texto')) ? `<li class="${opt.correta ? 'correta' : ''}">${String(opt.texto)}</li>` : `<li class="erro">Opção inválida</li>`; }); inner += '</ul>';
                    } else if (p.tipo === 'Verdadeiro/Falso') inner = `<p><b>Correta:</b> ${p.resposta ?? 'N/A'}</p>`;
                    html += `<div class="pergunta-card"><div class="pergunta-card-conteudo"><span class="pergunta-card-tipo">${p.tipo || 'Inválido'}</span><p class="pergunta-card-enunciado">${i + 1}. ${p.enunciado || 'Em falta'}</p>${inner}</div></div>`;
                }); return html;
            }

            // --- Carregar Provas Criadas ---
            function carregarProvasCriadas() {
                let banco = [];
                try {
                    const stored = localStorage.getItem('bancoDeProvas');
                    if (!stored) {
                        listaProvasCriadasEl.innerHTML = '<p>Nenhuma prova criada.</p>';
                        return;
                    }
                    
                    banco = JSON.parse(stored);
                    if (!Array.isArray(banco)) {
                        errorService.handleError('storage', new Error('Banco de provas inválido'));
                        banco = [];
                    }
                } catch (e) {
                    errorService.handleError('storage', new Error('Erro ao ler banco de provas'));
                    listaProvasCriadasEl.innerHTML = '<p style="color: red;">Erro leitura.</p>';
                    return;
                }

                if (banco.length === 0) {
                    listaProvasCriadasEl.innerHTML = '<p>Nenhuma prova criada.</p>';
                    return;
                }
                listaProvasCriadasEl.innerHTML = ''; 
                banco.slice().reverse().forEach((prova, i) => {
                    if(!prova || typeof prova !== 'object') { listaProvasCriadasEl.innerHTML += `<div class="prova-criada-card erro"><p>Erro: Prova inválida.</p></div>`; return; }
                    const card = document.createElement('div'); card.className = 'prova-criada-card'; const titulo = (prova.titulo || 'S/ Título').replace(/"/g, '&quot;'); const id = `prova-${Date.now()}-${i}`; const nPerg = Array.isArray(prova.perguntas) ? prova.perguntas.length : 0;
                    const details = gerarHTMLDetalheProva(prova.perguntas);
                    card.innerHTML = `<div class="prova-criada-header" data-target-id="${id}"><div class="prova-criada-info"><h4>${prova.titulo || 'S/ Título'}</h4><p>${nPerg} Pergunta(s)</p></div><div class="prova-criada-acoes"><button class="btn btn-perigo btn-remover-prova-criada" data-titulo="${titulo}">Remover</button><span class="prova-criada-seta" id="seta-${id}">▼</span></div></div><div class="prova-criada-body" id="${id}">${details}</div>`;
                    listaProvasCriadasEl.appendChild(card);
                });
                listaProvasCriadasEl.querySelectorAll('.prova-criada-header').forEach(h => { h.addEventListener('click', (e) => { if (e.target.classList.contains('btn-remover-prova-criada')) return; e.stopPropagation(); const tId = h.getAttribute('data-target-id'); const b = document.getElementById(tId); const s = document.getElementById(`seta-${tId}`); if (b && s) { const open = b.style.display === 'block'; b.style.display = open ? 'none' : 'block'; s.classList.toggle('aberto', !open); s.textContent = open ? '▼' : '▲'; } }); });
                listaProvasCriadasEl.querySelectorAll('.btn-remover-prova-criada').forEach(b => { b.addEventListener('click', (e) => { e.stopPropagation(); const tit = e.target.getAttribute('data-titulo'); if (confirm(`Apagar prova "${tit}"?`)) { removerProvaDoBanco(tit); carregarProvasCriadas(); } }); });
            }

            // --- Remover Prova ---
            function removerProvaDoBanco(titulo) {
                let banco = []; try { banco = JSON.parse(localStorage.getItem('bancoDeProvas')) || []; if(!Array.isArray(banco)) banco = []; } catch(e) {/* */}
                banco = banco.filter(p => p && p.titulo !== titulo); localStorage.setItem('bancoDeProvas', JSON.stringify(banco));
            }

            // --- Carregar Resultados ---
            function carregarResultadosProfessor() {
                let banco = [];
                try {
                    const stored = localStorage.getItem('bancoDeResultados');
                    if (!stored) {
                        listaResultadosEl.innerHTML = '<p>Nenhum resultado.</p>';
                        return;
                    }

                    banco = JSON.parse(stored);
                    if (!Array.isArray(banco)) {
                        errorService.handleError('storage', new Error('Banco de resultados inválido'));
                        banco = [];
                    }
                } catch (e) {
                    errorService.handleError('storage', new Error('Erro ao ler banco de resultados'));
                    listaResultadosEl.innerHTML = '<p style="color: red;">Erro leitura.</p>';
                    return;
                }

                if (banco.length === 0) {
                    listaResultadosEl.innerHTML = '<p>Nenhum resultado.</p>';
                    return;
                }
                listaResultadosEl.innerHTML = ''; 
                banco.slice().reverse().forEach(sub => {
                    if (!sub || typeof sub !== 'object' || !sub.id || !Array.isArray(sub.detalhes)) { listaResultadosEl.innerHTML += `<div class="submissao-card erro"><p>Erro: Submissão inválida.</p></div>`; return; }
                    
                    const div = document.createElement('div'); div.className = 'submissao-card'; 
                    const nome = sub.nomeAluno || "Anónimo"; 
                    const data = new Date(sub.id).toLocaleString('pt-PT'); 
                    let pts = `Pontos: ${sub.pontuacao}/${sub.totalCorrigiveis}`; 
                    if (sub.totalCorrigiveis === 0) pts = `Total: ${sub.totalPerguntas} (Manual)`;
                    
                    // ID único para o conteúdo a ser exportado e nome do ficheiro
                    const pdfContentId = `pdf-content-${sub.id}`;
                    const pdfFileName = `Prova_${sub.tituloProva || 'Prova'}_${nome}.pdf`.replace(/[^a-z0-9_.-]/gi, '_'); // Nome do ficheiro limpo

                    let hHTML = `<div class="submissao-header" data-target-id="${sub.id}"><div class="submissao-header-info"><h3>${sub.tituloProva || 'S/ Título'}</h3><p><strong>Aluno: ${nome}</strong></p><p>${data}</p><p class="submissao-pontuacao-header">${pts}</p></div><span class="submissao-seta" id="seta-${sub.id}">▼</span></div>`;
                    
                    // Início do body
                    let bHTML = `<div class="submissao-body" id="body-${sub.id}">`;
                    
                    // Wrapper para o conteúdo do PDF
                    bHTML += `<div id="${pdfContentId}">`; 
                    bHTML += `<h2 style="color: var(--cor-principal);">Resultados da Prova</h2>`;
                    bHTML += `<h3 style="color: #333;">${sub.tituloProva || 'S/ Título'}</h3>`;
                    bHTML += `<p><strong>Aluno:</strong> ${nome}</p>`;
                    bHTML += `<p><strong>Data:</strong> ${data}</p>`;
                    bHTML += `<p style="font-weight: bold; color: var(--cor-principal); margin-bottom: 20px; border-top: 1px solid #eee; padding-top: 10px;">${pts}</p>`;

                    // Loop dos detalhes
                    sub.detalhes.forEach((det, i) => { 
                        if (typeof det !== 'object' || det === null) { bHTML += `<div class="resultado-card pendente"><p>Erro detalhe ${i+1}.</p></div>`; return; } 
                        const rAl = String(det.respostaAluno || "").replace(/</g, "&lt;"); 
                        bHTML += `<div class="resultado-card ${det.status || 'pendente'}" style="page-break-inside: avoid;">
                                    <p class="questao-enunciado">${i + 1}. ${det.enunciado || 'Inválido'}</p>
                                    <p class="resposta-aluno">Aluno: ${rAl}</p>
                                    <p class="resposta-correta-info">${det.info || 'N/A'}</p>
                                  </div>`; 
                    });
                    
                    bHTML += `</div>`; // Fim do wrapper pdf-content

                    // Botão de Exportar (Fora do wrapper de conteúdo)
                    bHTML += `<button class="btn btn-primario btn-exportar-pdf" 
                                      data-pdf-content-id="${pdfContentId}" 
                                      data-pdf-filename="${pdfFileName}" 
                                      style="margin-top: 20px;">
                                  Exportar para PDF
                              </button>`;

                    bHTML += '</div>'; // Fim do submissao-body
                    div.innerHTML = hHTML + bHTML; 
                    listaResultadosEl.appendChild(div);
                });
                
                // Listener do acordeão
                listaResultadosEl.querySelectorAll('.submissao-header').forEach(h => { 
                    h.addEventListener('click', (e) => { 
                        e.stopPropagation(); const sId = h.getAttribute('data-target-id'); if (!sId) return; 
                        const b = document.getElementById(`body-${sId}`); const s = document.getElementById(`seta-${sId}`); 
                        if (b && s) { 
                            const open = b.style.display === 'block'; b.style.display = open ? 'none' : 'block'; 
                            s.classList.toggle('aberto', !open); s.textContent = open ? '▼' : '▲'; 
                            h.style.borderRadius = open ? "8px" : "8px 8px 0 0"; 
                            h.style.borderBottom = open ? "1px solid var(--cor-borda)" : "none"; 
                        } 
                    }); 
                });

                // Listener para os botões PDF
                listaResultadosEl.querySelectorAll('.btn-exportar-pdf').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Impede que o acordeão feche
                        const contentId = e.target.dataset.pdfContentId;
                        const fileName = e.target.dataset.pdfFilename;
                        const element = document.getElementById(contentId);

                        if (!element) {
                            alert("Erro: Não foi possível encontrar o conteúdo para exportar.");
                            return;
                        }
                        
                        if (typeof html2pdf === 'undefined') {
                            alert("Erro: A biblioteca de PDF (html2pdf) não foi carregada. Verifique a sua ligação à internet.");
                            return;
                        }
                        
                        btn.disabled = true;
                        btn.textContent = "A exportar...";
                        
                        const opt = {
                            margin:       1,
                            filename:     fileName,
                            image:        { type: 'jpeg', quality: 0.98 },
                            html2canvas:  { scale: 2, useCORS: true },
                            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                        };

                        // A função html2pdf() é da biblioteca externa
                        html2pdf().from(element).set(opt).save().then(() => {
                            btn.disabled = false;
                            btn.textContent = "Exportar para PDF";
                        }).catch((err) => {
                            alert(`Erro ao exportar: ${err.message}`);
                            btn.disabled = false;
                            btn.textContent = "Exportar para PDF";
                        });
                    });
                });
            }

            // --- Funções Auxiliares ---
            function adicionarPerguntaAoArray(p) { provaPerguntas.push(p); renderizarPreviewPerguntas(); }
            function renderizarPreviewPerguntas() {
                listaPerguntasPreview.innerHTML = ''; if (provaPerguntas.length === 0) return;
                provaPerguntas.forEach((p, i) => {
                    const card = document.createElement('div'); card.className = 'pergunta-card'; let inner = '';
                    if (p.tipo === 'Escolha Múltipla' && Array.isArray(p.opcoes)) { inner = '<ul class="pergunta-card-opcoes">'; p.opcoes.forEach(opt => { if(typeof opt === 'object' && opt !== null && opt.hasOwnProperty('texto')) inner += `<li class="${opt.correta ? 'correta' : ''}">${String(opt.texto)}</li>`; }); inner += '</ul>'; } 
                    else if (p.tipo === 'Verdadeiro/Falso') inner = `<p><b>Correta:</b> ${p.resposta ?? 'N/A'}</p>`;
                    card.innerHTML = `<div class="pergunta-card-conteudo"><span class="pergunta-card-tipo">${p.tipo||'Inv.'}</span><p class="pergunta-card-enunciado">${i+1}. ${p.enunciado||'Inv.'}</p>${inner}</div><button class="btn btn-perigo btn-remover-pergunta" data-index="${i}">X</button>`;
                    listaPerguntasPreview.appendChild(card);
                });
                listaPerguntasPreview.querySelectorAll('.btn-remover-pergunta').forEach(b => { b.addEventListener('click', (e) => { e.stopPropagation(); const idx = parseInt(b.getAttribute('data-index'), 10); if (confirm('Remover pergunta?')) { provaPerguntas.splice(idx, 1); renderizarPreviewPerguntas(); } }); });
            }
            function resetarModal() {
                allModalViews.forEach(v => v.style.display = 'none'); [formVF, formEscrita, formMultipla, formGerarIA].forEach(f => f.reset()); 
                opcoesContainer.innerHTML = ''; iaNumMultipla.value = 5; iaNumVF.value = 3; iaNumEscrita.value = 2;
            }

            // --- Funções de Gestão de Materiais ---

            /**
             * Carrega e exibe os materiais guardados no localStorage.
             */
            function carregarMateriais() {
                let banco = [];
                try {
                    const stored = localStorage.getItem('bancoDeMateriais');
                    if (!stored) {
                        listaMateriaisEl.innerHTML = '<p>Nenhum material criado.</p>';
                        return;
                    }

                    banco = JSON.parse(stored);
                    if (!Array.isArray(banco)) {
                        errorService.handleError('storage', new Error('Banco de materiais inválido'));
                        banco = [];
                    }
                } catch (e) {
                    errorService.handleError('storage', new Error('Erro ao ler banco de materiais'));
                    listaMateriaisEl.innerHTML = '<p style="color: red;">Erro ao ler materiais.</p>';
                    return;
                }

                if (banco.length === 0) {
                    listaMateriaisEl.innerHTML = '<p>Nenhum material criado.</p>';
                    return;
                }

                listaMateriaisEl.innerHTML = '';
                banco.slice().reverse().forEach(material => {
                    if (!material || typeof material !== 'object' || !material.id) return;
                    
                    const card = document.createElement('div');
                    card.className = 'prova-criada-card'; // Reutiliza o estilo de card
                    
                    // Escapa o título para o atributo data
                    const tituloEscapado = (material.title || 'S/ Título').replace(/"/g, '&quot;');
                    
                    card.innerHTML = `
                        <div class="prova-criada-header" style="cursor: default;">
                            <div class="prova-criada-info">
                                <h4>${material.title || 'S/ Título'}</h4>
                            </div>
                            <div class="prova-criada-acoes">
                                <button class="btn btn-aviso btn-editar-material" data-id="${material.id}">Editar</button>
                                <button class="btn btn-perigo btn-remover-material" data-id="${material.id}" data-titulo="${tituloEscapado}">Remover</button>
                            </div>
                        </div>
                    `;
                    listaMateriaisEl.appendChild(card);
                });
            }

            /**
             * Abre o modal para criar ou editar um material.
             * @param {object | null} material - O objeto do material a ser editado, ou null para criar um novo.
             */
            function abrirModalMaterial(material = null) {
                formMaterial.reset();
                if (material) {
                    // Modo Edição
                    modalMaterialTitulo.textContent = 'Editar Material';
                    materialIdInput.value = material.id;
                    materialTituloInput.value = material.title;
                    materialConteudoInput.value = material.content;
                } else {
                    // Modo Criação
                    modalMaterialTitulo.textContent = 'Novo Material';
                    materialIdInput.value = '';
                }
                modalMaterial.style.display = 'flex';
            }

            /**
             * Fecha o modal de materiais.
             */
            function fecharModalMaterial() {
                modalMaterial.style.display = 'none';
            }

            /**
             * Salva um material (novo ou editado) no localStorage.
             * @param {Event} e - O evento de submit do formulário.
             */
            function salvarMaterial(e) {
                e.preventDefault();
                const id = materialIdInput.value;
                const title = materialTituloInput.value.trim();
                const content = materialConteudoInput.value.trim();

                if (!title || !content) {
                    alert('Por favor, preencha o título e o conteúdo.');
                    return;
                }

                let banco = [];
                try {
                    banco = JSON.parse(localStorage.getItem('bancoDeMateriais')) || [];
                    if (!Array.isArray(banco)) banco = [];
                } catch (err) {
                    console.error("Erro ao ler bancoDeMateriais:", err);
                    banco = [];
                }

                if (id) {
                    // Editar
                    const index = banco.findIndex(m => m.id === id);
                    if (index !== -1) {
                        banco[index] = { ...banco[index], title, content };
                    } else {
                        // Se não encontrar, adiciona como novo (segurança)
                        banco.push({ id: new Date().toISOString(), title, content });
                    }
                } else {
                    // Criar
                    banco.push({ id: new Date().toISOString(), title, content });
                }

                try {
                    localStorage.setItem('bancoDeMateriais', JSON.stringify(banco));
                    fecharModalMaterial();
                    carregarMateriais();
                } catch (err) {
                    alert("Erro ao guardar o material. O LocalStorage pode estar cheio.");
                }
            }

            /**
             * Remove um material do localStorage.
             * @param {string} id - O ID do material a ser removido.
             */
            function removerMaterial(id) {
                let banco = [];
                try {
                    banco = JSON.parse(localStorage.getItem('bancoDeMateriais')) || [];
                    if (!Array.isArray(banco)) banco = [];
                } catch (err) { return; }

                banco = banco.filter(m => m.id !== id);
                localStorage.setItem('bancoDeMateriais', JSON.stringify(banco));
                carregarMateriais();
            }

            /**
             * Encontra um material pelo ID e abre o modal para edição.
             * @param {string} id - O ID do material a ser editado.
             */
            function editarMaterial(id) {
                let banco = [];
                try {
                    banco = JSON.parse(localStorage.getItem('bancoDeMateriais')) || [];
                } catch (err) { return; }
                
                const material = banco.find(m => m.id === id);
                if (material) {
                    abrirModalMaterial(material);
                } else {
                    alert('Erro: Material não encontrado.');
                }
            }

            // --- Funções Auxiliares para Materiais (Atualizadas) ---

            /**
             * Pede um URL de imagem e insere a tag HTML na textarea de conteúdo.
             */
            function inserirImagemMaterial() {
                const url = prompt("Cole o URL completo da imagem (ex: https://.../imagem.png):");
                if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                    const htmlImg = `\n<p style="text-align: center;"><img src="${url}" alt="Imagem" style="max-width: 90%; height: auto; border-radius: 5px;"></p>\n`;
                    insertarTextoNoTextarea(materialConteudoInput, htmlImg);
                } else if (url) {
                    alert("URL inválido. Deve começar com 'http://' ou 'https://'.");
                }
            }

            /**
             * Pede um URL do YouTube, extrai o ID e insere o iframe responsivo.
             */
            function inserirVideoYoutube() {
                const url = prompt("Cole o URL do vídeo do YouTube (link da barra de endereços ou de partilha):");
                if (!url) return;

                const videoId = extrairVideoIdYouTube(url);
                
                if (videoId) {
                    // Estilo para wrapper responsivo (16:9)
                    const htmlVideo = `
    <div style="position: relative; padding-bottom: 56.25%; /* 16:9 */ height: 0; overflow: hidden; max-width: 100%; margin: 10px 0;">
        <iframe 
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 5px;"
            src="https://www.youtube.com/embed/${videoId}" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen
            title="Vídeo do YouTube">
        </iframe>
    </div>\n`;
                    insertarTextoNoTextarea(materialConteudoInput, htmlVideo);
                } else {
                    alert("Não foi possível extrair o ID do vídeo do YouTube. Por favor, use um link válido (ex: 'https://www.youtube.com/watch?v=...' ou 'https://youtu.be/...').");
                }
            }

            /**
             * (Nova Função) Pede um URL de MP4 e insere a tag <video>
             */
            function inserirVideoMp4() {
                const url = prompt("Cole o URL direto para o seu ficheiro .mp4 (ex: https://meusite.com/video.mp4).\nO vídeo deve estar alojado online.");
                // Validação simples
                if (url && (url.startsWith('http://') || url.startsWith('https://')) && url.toLowerCase().endsWith('.mp4')) {
                    const htmlVideo = `
    <div style="margin: 10px 0;">
        <video controls style="width: 100%; max-width: 100%; border-radius: 5px;">
            <source src="${url}" type="video/mp4">
            O seu navegador não suporta a tag de vídeo.
        </video>
    </div>\n`;
                    insertarTextoNoTextarea(materialConteudoInput, htmlVideo);
                } else if (url) {
                    alert("URL inválido. Por favor, insira um link direto que comece com 'http' ou 'https' e termine em '.mp4'.");
                }
            }

            /**
             * Extrai o ID de um vídeo do YouTube de vários formatos de URL.
             * @param {string} url - O URL do YouTube.
             * @returns {string | null} O ID do vídeo ou null.
             */
            function extrairVideoIdYouTube(url) {
                let videoId = null;
                try {
                    // Expressão regular para encontrar o ID em vários formatos de URL do YouTube
                    const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                    const match = url.match(regex);
                    if (match && match[1]) {
                        videoId = match[1];
                    }
                } catch (e) {
                    console.error("Erro ao processar regex do YouTube:", e);
                    return null;
                }
                return videoId;
            }

            /**
             * Insere texto na textarea de conteúdo do material, no final.
             * @param {HTMLTextAreaElement} textarea - A textarea.
             * @param {string} texto - O texto HTML a ser inserido.
             */
            function insertarTextoNoTextarea(textarea, texto) {
                // Insere no final, que é mais simples e seguro do que gerir cursores
                textarea.value += texto;
                textarea.scrollTop = textarea.scrollHeight; // Rola para o fim
                textarea.focus();
            }


        }); // Fim DOMContentLoaded
    </script>
</body>
</html>